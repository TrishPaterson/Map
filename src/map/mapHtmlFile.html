<!DOCTYPE html>
<html>
    <head>
        <title>Whitby</title>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #map {
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
            var map;
    function initMap() {
        var eventLocation = new google.maps.LatLng(-41.1130274, 174.8924949); // Location of event. When scenario is created LatLng will be put in here.
        var currentEvent;
        currentEvent = 'Whitby';
        map = new google.maps.Map(document.getElementById('map'), {
            center: eventLocation,
            zoom: 17,
        });             
//-----------------------------------------------------------------------------------------------
//City Location 
        var citymap = {
            well: {
                center: {lat: -41.2865, lng: 174.7762},
                rad: 20,
                name: 'Wellington'
            },
            petone: {
                center: {lat: -41.2270, lng: 174.8851},
                rad: 20,
                name: 'Petone'
            },
            lwrhutt: {
                center: {lat: -41.2092, lng: 174.9081},
                rad: 20,
                name: 'Lower Hutt'
            },
            whitby: {
                center: {lat: -41.1130274, lng: 174.8924949},
                rad: 20,
                name: 'Whitby'
            }
        };    
        //currentArea = citymap.whitby.name;
//-----------------------------------------------------------------------------------------------        
        function CenterControl(controlDiv, map, latLong, name) {
            var controlUI = document.createElement('div');
            var controlText = document.createElement('div');          
            setUIStyle(controlUI, controlDiv);
            setTextStyle(controlText, controlUI, name);
            actionPerform(controlUI, map, latLong, name);
        }    
        function setUIStyle(ui, div){
            ui.style.backgroundColor = '#fff';
            ui.style.border = '2px solid #fff';
            ui.style.borderRadius = '3px';
            ui.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
            ui.style.cursor = 'pointer';
            ui.style.marginBottom = '22px';
            ui.style.textAlign = 'center';
            ui.title = 'Click to recenter the map';
            div.appendChild(ui);
        }   

        function setTextStyle(text, ui, cityName){
            text.style.color = 'rgb(25,25,25)';
            text.style.fontFamily = 'Roboto,Arial,sans-serif';
            text.style.fontSize = '10px';
            text.style.lineHeight = '38px';
            text.style.paddingLeft = '5px';
            text.style.paddingRight = '5px';
            text.innerHTML = cityName;
            ui.appendChild(text);
        }
        
        function actionPerform(controlUI, map, latLong, name ){
            controlUI.addEventListener('click', function(){
                map.setCenter(latLong);
                currentEvent = name;
            });
        }
        
        var centerControlDiv = document.createElement('div');
        var centerControl = new CenterControl(centerControlDiv, map, citymap.well.center, citymap.well.name);
        var centerControl = new CenterControl(centerControlDiv, map, citymap.petone.center, citymap.petone.name);
        var centerControl = new CenterControl(centerControlDiv, map, citymap.whitby.center, citymap.whitby.name);
        var centerControl = new CenterControl(centerControlDiv, map, citymap.lwrhutt.center, citymap.lwrhutt.name);
        centerControlDiv.index = 1;
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(centerControlDiv);
//-----------------------------------------------------------------------------------------------
//ExpandingZone
        var cityCircle = [];
                
        for (var city in citymap) {
            var circle = new google.maps.Circle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                center: citymap[city].center,
                radius: Math.sqrt(citymap[city].rad),
            });
            cityCircle.push(circle);
        }
                 
        var expansionDirection = 1;
        var timeDelay = 50, maxRad = 190;
        var initEscape = 100;  // simulates the burgular running at the
        setInterval(function ()
        {
            var radius;
            for(var i = 0; i < cityCircle.length; i++){
                radius = cityCircle[i].getRadius();
                if (radius < timeDelay)
                {
                    expansionDirection;
                } 
                else if (radius >= maxRad)
                {
                    expansionDirection = 0;
                }
                if (radius <= initEscape)
                {
                    cityCircle[i].setRadius(radius + expansionDirection * 1.0);
                } 
                else if (radius >= initEscape)
                {
                    cityCircle[i].setRadius(radius + expansionDirection * 0.5);
                }
            }
        }, 50);
//-----------------------------------------------------------------------------------------------
//Placing Cordons
        var num = (function() { //counter
            var count = 0;   
            return function() { return count++; };  
        })(); 

        var wellMarkers = [];
        var petoneMarkers = [];
        var lwrhuttMarkers = [];
        var whitbyMarkers = [];

        map.addListener('click', function(event) {
            addMarker(event.latLng);
            //setMapOnAll(map);
        });
      
        function addMarker(location) {
            var marker = new google.maps.Marker({
                position: location,
                map: map,
                icon: 'policeCar.ico'
            });
            var unit = new google.maps.InfoWindow({
                content: 'WLT ' + num()});
            unit.open(map,marker);
            
            if( currentEvent === 'Wellington') {
                wellMarkers.push(marker); //add marker to array
            }
            else if( currentEvent === 'Petone') {
                petoneMarkers.push(marker);
            }
            else if( currentEvent === 'Lower Hutt') {
                lwrhuttMarkers.push(marker);
            }
            else if( currentEvent === 'Whitby' ) {
                whitbyMarkers.push(marker);
            }
            setContainment();
        }
        /*
        function setMapOnAll(map) {
            for (var i = 0; i < wellMarkers.length; i++) {
                wellMarkers[i].setMap(map);
            }
            for (var i = 0; i < petoneMarkers.length; i++) {
                petoneMarkers[i].setMap(map);
            }
            for (var i = 0; i < lwrhuttMarkers.length; i++) {
                lwrhuttMarkers[i].setMap(map);
            }
            for (var i = 0; i < whitbyMarkers.length; i++) {
                whitbyMarkers[i].setMap(map);
            }
        }*/
        //Containment Field
        //----------------------------------------------------------------------
        //create an array that stores arrays that hold x and y coordinates where
        //x is the lat and y is the lng coordinates of the cordon marker.
        //----------------------------------------------------------------------
        function createContainmentPoints( mark ) {
            var lat;
            var lng;
            containmentPoints.length = 0;
            for( var i = 0; i < mark.length; i++ ) {
                lat = mark[i].getPosition().lat();
                lng = mark[i].getPosition().lng();
                containmentPoints.push( [lat, lng] );
            }
        }
        //----------------------------------------------------------------------
        //cross function determines whether the coordinate/marker currently 
        //being checked is to the left, or right of the last 2 points in the
        //containmentPointsPath array. It is called from inside convexHull() 
        //function. 
        //o and a are the points that form the most recent line in the
        //hull. b is the next point being checked, whether it should be 
        //considered as point to form the hull, or discarded.
        function cross( o, a, b ) {
            return ( a[0] - o[0] ) * ( b[1] - o[1] ) -
                   ( a[1] - o[1] ) * ( b[0] - o[0] );
        }
        //----------------------------------------------------------------------
        //convexHull fills the containmentPointsPath array, which is used to 
        //create the containment zone. The upper hull and lower hull are 
        //created separately then merged together.
        function convexHull() {
            //sort the array of all possible points, so we can start from the 
            //beginning of the array for the lower hull, and start from the end
            //of the array for the upper hull.
            containmentPoints.sort( function(a,b) {
                return a[0] == b[0] ? 
                       a[1] - b[1]  : a[0] - b[0];
            });
            //Find all the points that are relevant to make the lower hull
            var lower = [];
            for( var i = 0; i < containmentPoints.length; i++ ) {
                while( lower.length >= 2 && 
                        cross( lower[ lower.length - 2], 
                               lower[ lower.length - 1],
                               containmentPoints[i]) <= 0 ) 
                {
                    lower.pop();           
                }
                lower.push( containmentPoints[i] );
            }
            //Find all the points that are relevant to make the upper hull
            var upper = [];
            for( var i = containmentPoints.length - 1; i >= 0; i-- ) {
                while( upper.length >= 2 && 
                        cross( upper[ upper.length - 2], 
                               upper[ upper.length - 1],
                               containmentPoints[i]) <= 0 ) 
                {
                    upper.pop();           
                }
                upper.push( containmentPoints[i] );
            }
            upper.pop();
            lower.pop();
            var hull = lower.concat(upper);
            //Put the x and y coordinates back in the form of LatLng object
            //so a polygon can be created.
            for( var i = 0; i < hull.length; i++ ) {
                containmentPointsPath.push( 
                        new google.maps.LatLng( hull[i][0], hull[i][1] ));
            }
        }
        //----------------------------------------------------------------------
        //setContainment uses the containmentPointsPath to create the zone
        var containmentPointsPath = []; //only stores the latlng points 
                                        //that will be used to form the zone
        var containmentPoints = []; //stores all the cordon markers in the form
                                    //of thier position i.e. latlong                          
        var wellZone;    //the polygon zone
        var petoneZone;
        var lwrhuttZone;
        var whitbyZone;
        
        function createContainment( markers, zone ) {
            containmentPointsPath = [];
            if( markers.length > 2 ) {
                createContainmentPoints( markers );
                convexHull();
                zone = new google.maps.Polygon({
                    paths: containmentPointsPath,
                    strokeColor: '#7f7fff',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#7f7fff',
                    fillOpacity: 0.35
                });
                return zone;
            }
        }
        
        function setContainment() {
            if( currentEvent === 'Wellington' ) {
                if( wellZone ) {
                    wellZone.setMap(null);
                    wellZone = null;
                }
                wellZone = createContainment( wellMarkers, wellZone );
                wellZone.setMap(map);
            }
            else if( currentEvent === 'Petone') {
                if( petoneZone ) {
                    petoneZone.setMap(null);
                    petoneZone = null;
                }
                petoneZone = createContainment( petoneMarkers, petoneZone );
                petoneZone.setMap(map);
            }
            else if( currentEvent === 'Lower Hutt') {
                if( lwrhuttZone ) {
                    lwrhuttZone.setMap(null);
                    lwrhuttZone = null;
                }
                lwrhuttZone = createContainment( lwrhuttMarkers, lwrhuttZone );
                lwrhuttZone.setMap(map);
            }
            else if( currentEvent === 'Whitby') {
                if( whitbyZone ) {
                    whitbyZone.setMap(null);
                    whitbyZone = null;
                }
                whitbyZone = createContainment( whitbyMarkers, whitbyZone );
                whitbyZone.setMap(map);
            }
        //----------------------------------------------------------------------
        }
    }// end initMap() do not add code below this closing bracket
//--------------------------------------------------------------------------------------------
        google.maps.event.addDomListener(window, 'load', initialize);
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmE4K2a37cqq8wdmkTudyrRkDVbNEtx-4&callback=initMap"
        async defer></script>
    </body>
</html>
